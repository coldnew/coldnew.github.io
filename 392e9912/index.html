<!doctype html>
<html class="theme-next use-motion theme-next-mist">
  <head><meta name="generator" content="Hexo 3.9.0">
  

<script type="text/javascript" src="/vendors/jquery/dist/jquery.min.js"></script>
<link rel="stylesheet" href="/vendors/bootstrap/dist/css/bootstrap.min.css" type="text/css">
<script type="text/javascript" src="/vendors/bootstrap/dist/js/bootstrap.min.js"></script>
<script type="text/javascript" src="/js/responsive.js"></script>

<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">


<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">


  <meta name="google-site-verification" content="2KupV-VpD04LYh25td4WXU0FNSfAQUQjYs13zPnAXls">



  <meta name="msvalidate.01" content="A2F329127555BDD555949FFD886CFF2B">



  <meta name="baidu-site-verification" content="fwxmwVqWtK,5z58vsAQKG">





  <link rel="stylesheet" type="text/css" href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5">




<link rel="stylesheet" type="text/css" href="/css/main.css?v=0.4.5.1">




  <meta name="keywords" content="clojure,clojurescript,emulator,">



  <link rel="alternate" href="/rss.xml" title="coldnew&#39;s blog" type="application/atom+xml">



  <link rel="shorticon icon" type="image/x-icon" href="/favicon.ico?v=0.4.5.1">


<meta name="description" content="4917 微處理器是 澳大利亞新南威爾斯大學 (UNSW) 教授 Richard Buckland 所開授課程 COMP1917 裡面所講述的一個專為該課程設計的虛擬微處理器，此微處理器並未在市面上販 售。    4917 是一個 4-bit，具有 4 個暫存器以及 16 個記憶體空間 (4bit * 16) 的微控器，屬 於 Von Newman 架構 (程式和資料儲存在同一份記憶體), 和">
<meta name="keywords" content="clojure,clojurescript,emulator">
<meta property="og:type" content="article">
<meta property="og:title" content="使用 Clojure 打造 4917 微處理器的模擬器">
<meta property="og:url" content="https://coldnew.github.io/392e9912/index.html">
<meta property="og:site_name" content="coldnew&amp;#39;s blog">
<meta property="og:description" content="4917 微處理器是 澳大利亞新南威爾斯大學 (UNSW) 教授 Richard Buckland 所開授課程 COMP1917 裡面所講述的一個專為該課程設計的虛擬微處理器，此微處理器並未在市面上販 售。    4917 是一個 4-bit，具有 4 個暫存器以及 16 個記憶體空間 (4bit * 16) 的微控器，屬 於 Von Newman 架構 (程式和資料儲存在同一份記憶體), 和">
<meta property="og:locale" content="zh-tw">
<meta property="og:image" content="https://coldnew.github.io/392e9912/example1.png">
<meta property="og:image" content="https://coldnew.github.io/392e9912/example2.png">
<meta property="og:image" content="https://coldnew.github.io/392e9912/example3.png">
<meta property="og:image" content="https://coldnew.github.io/392e9912/example4.png">
<meta property="og:image" content="https://coldnew.github.io/392e9912/example5.png">
<meta property="og:image" content="https://coldnew.github.io/392e9912/example6.png">
<meta property="og:image" content="https://coldnew.github.io/392e9912/example7.png">
<meta property="og:updated_time" content="2015-06-29T05:12:00.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="使用 Clojure 打造 4917 微處理器的模擬器">
<meta name="twitter:description" content="4917 微處理器是 澳大利亞新南威爾斯大學 (UNSW) 教授 Richard Buckland 所開授課程 COMP1917 裡面所講述的一個專為該課程設計的虛擬微處理器，此微處理器並未在市面上販 售。    4917 是一個 4-bit，具有 4 個暫存器以及 16 個記憶體空間 (4bit * 16) 的微控器，屬 於 Von Newman 架構 (程式和資料儲存在同一份記憶體), 和">
<meta name="twitter:image" content="https://coldnew.github.io/392e9912/example1.png">


<script type="text/javascript" id="hexo.configuration">
  var CONFIG = {
    scheme: 'Mist',
    sidebar: 'post'
  };
</script>

  <title> 使用 Clojure 打造 4917 微處理器的模擬器 | coldnew&#39;s blog </title>
</head>

<body itemscope="" itemtype="https://schema.org/WebPage" lang="zh-tw,en,default">

  <!--[if lte IE 8]>
  <div style=' clear: both; height: 59px; padding:0 0 0 15px; position: relative;margin:0 auto;'>
    <a href="https://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
      <img src="https://7u2nvr.com1.z0.glb.clouddn.com/picouterie.jpg" border="0" height="42" width="820"
           alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today or use other browser ,like chrome firefox safari."
           style='margin-left:auto;margin-right:auto;display: block;'/>
    </a>
  </div>
<![endif]-->

  
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-42122243-1', 'auto');
  ga('send', 'pageview');
</script>




  <div class="container-fluid one-column page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope="" itemtype="https://schema.org/WPHeader">
      <div class="header-inner"><link rel="canonical" href="https://coldnew.github.io/392e9912/">
<h1 class="site-meta">
  <span class="logo-line-before"><i></i></span>
  <a href="/" class="brand" rel="start">
      <span class="logo">
        <i class="icon-next-logo"></i>
      </span>
      <span class="site-title">coldnew&#39;s blog</span>
  </a>
  <span class="logo-line-after"><i></i></span>
</h1>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu ">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon icon-next-home"></i> <br>
            首頁
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            <i class="menu-item-icon icon-next-categories"></i> <br>
            分類
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            <i class="menu-item-icon icon-next-archives"></i> <br>
            歸檔
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            <i class="menu-item-icon icon-next-tags"></i> <br>
            標籤
          </a>
        </li>
      

      
      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div id="content" class="content"> 

  <div id="posts" class="posts-expand">
    

  <article class="post post-type-normal " itemscope="" itemtype="https://schema.org/Article">
    <header class="post-header">

      
      
        <h1 class="post-title" itemprop="name headline">
          
          
            
              使用 Clojure 打造 4917 微處理器的模擬器
            
          
        </h1>
      

      <div class="post-meta">
        <span class="post-time">
          最後更新
          <time itemprop="dateCreated" datetime="2015-06-29T13:12:00+08:00" content="2015-06-29">
            2015-06-29
          </time>
        </span>

        

        
          
        
      </div>
    </header>

    <div class="post-body">

      
      

      
        <span itemprop="articleBody"><div id="content">
<p>
4917 微處理器是 <a href="https://en.wikipedia.org/wiki/University_of_New_South_Wales" target="_blank" rel="noopener">澳大利亞新南威爾斯大學</a> (UNSW) 教授 Richard Buckland 所開授課程
COMP1917 裡面所講述的一個專為該課程設計的虛擬微處理器，此微處理器並未在市面上販
售。
</p>

<p>
4917 是一個 4-bit，具有 4 個暫存器以及 16 個記憶體空間 (4bit * 16) 的微控器，屬
於 <a href="https://en.wikipedia.org/wiki/Von_Neumann_architecture" target="_blank" rel="noopener">Von Newman 架構 </a>(程式和資料儲存在同一份記憶體), 和當今電腦、手機使用的 64-bit
CPU 相比相差甚遠，但是非常適合用來學習一個 CPU 的運作以及模擬器的撰寫。
</p>

<p>
在這篇文章中，我們將使用 Clojure 1.7 的新功能 <a href="http://dev.clojure.org/display/design/Reader%2BConditionals" target="_blank" rel="noopener">Reader Conditionals</a> 一次實現
node.js (clojurescript) 以及 JVM (clojure) 的版本。
</p>

<div id="outline-container-orgbe225a2" class="outline-2">
<h2 id="orgbe225a2">4917 的暫存器 (Register)</h2>
<div class="outline-text-2" id="text-orgbe225a2">
<p>
4917 共具有 4 個暫存器，分別為 R0, R1, PC, IS, 其用途如下表
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col class="org-left">

<col class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">暫存器 (Register)</th>
<th scope="col" class="org-left">用途</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">R0</td>
<td class="org-left">暫存資料用</td>
</tr>

<tr>
<td class="org-left">R1</td>
<td class="org-left">暫存資料用</td>
</tr>

<tr>
<td class="org-left">PC</td>
<td class="org-left">儲存目前指向記憶體的位址</td>
</tr>

<tr>
<td class="org-left">IS</td>
<td class="org-left">儲存目前執行的指令集 (Instruction Set)</td>
</tr>
</tbody>
</table>

<div class="alert">
<p>
有些人的 4917 模擬器會將 PC (Program Counter) 命名為 IP (Instruction Pointer)，
這個名稱比較常用在 x86 的 CPU 上，但是用途是相同的。
</p>

</div>
</div>
</div>

<div id="outline-container-org84850a9" class="outline-2">
<h2 id="org84850a9">從指令集認識 4917</h2>
<div class="outline-text-2" id="text-org84850a9">
<p>
4917 共有 16 種指令，其中 0 ~ 7 這一類的指令屬於 1-byte 指令，不接受而外的參數，
而 8 ~ 15 這幾個操作碼則會接受 Program counter (或稱為 Instruction pointer) 所指
向的下一個目標作為資料 &lt;﻿data﻿&gt; 來進行接下來的動作，屬於 2-byte
指令。
</p>

<div class="alert">
<p>
實際上 4917 為 4-bit 微處理器，其使用的 memory 或是暫存空間都是以 4-bit (1byte =
8bit) 作為單位的，本文參考部分文章的描述，仍以 byte 當作他的單位。 (實際上 4-bit 稱作 <b>nibble</b>)
</p>

</div>

<p>
下表列出了其指令與含義:
</p>
</div>

<div id="outline-container-orgc4b780e" class="outline-3">
<h3 id="orgc4b780e">1-byte 指令</h3>
<div class="outline-text-3" id="text-orgc4b780e">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col class="org-right">

<col class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">指令 (op code)</th>
<th scope="col" class="org-left">含義</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">0</td>
<td class="org-left">結束程式</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-left">R0 和 R1 相加，結果存入 R0</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-left">R0 和 R1 相減，結果存入 R0</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-left">R0 數值加一</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-left">R1 數值加一</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-left">R0 數值減一</td>
</tr>

<tr>
<td class="org-right">6</td>
<td class="org-left">R1 數值減一</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-left">響蜂鳴器</td>
</tr>
</tbody>
</table>
</div>
</div>

<div id="outline-container-org2685b39" class="outline-3">
<h3 id="org2685b39">2-byte 指令，指令後面的 byte 的內容以 &lt;﻿data﻿&gt; 表示</h3>
<div class="outline-text-3" id="text-org2685b39">
<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col class="org-right">

<col class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-right">指令 (op code)</th>
<th scope="col" class="org-left">含義</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-right">8</td>
<td class="org-left">印出 &lt;﻿data﻿&gt; 內容</td>
</tr>

<tr>
<td class="org-right">9</td>
<td class="org-left">從位址 &lt;﻿﻿data﻿﻿&gt; 讀取資料存入 R0</td>
</tr>

<tr>
<td class="org-right">10</td>
<td class="org-left">從位址 &lt;﻿data﻿&gt; 讀取資料存入 R1</td>
</tr>

<tr>
<td class="org-right">11</td>
<td class="org-left">將 R0 內容存入 位址 &lt;﻿data﻿&gt; 內</td>
</tr>

<tr>
<td class="org-right">12</td>
<td class="org-left">將 R1 內容存入 位址 &lt;﻿data﻿&gt; 內</td>
</tr>

<tr>
<td class="org-right">13</td>
<td class="org-left">將 PC 指向 位址 &lt;﻿data﻿&gt; (即 JUMP 命令)</td>
</tr>

<tr>
<td class="org-right">14</td>
<td class="org-left">如果 R0 為 0，將 PC 指向 位址 &lt;﻿data﻿&gt;</td>
</tr>

<tr>
<td class="org-right">15</td>
<td class="org-left">如果 R0 不為 0, 將 PC 指向 位址 &lt;﻿data﻿&gt;</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>

<div id="outline-container-org9c5dd10" class="outline-2">
<h2 id="org9c5dd10">從範例來看 4917 的指令運作</h2>
<div class="outline-text-2" id="text-org9c5dd10">
<p>
我們可以使用簡單的範例來了解 4917 的運作，假設目前的記憶體內容如下:
</p>


<div class="figure">
<p><img src="example1.png">
</p>
</div>

<p>
這樣 4917 會怎樣運作呢? 首先因為 PC 指向了 8，而 8 是 2-byte 指令，代表印出下一
個位置 (PC + 1) 的內容，因此會在終端機上顯示 <code>5</code> ，接著程式遇到了 0, 結束這一回
合。
</p>

<p>
很簡單對不對?我們來看比較難一點點的範例，假設目前記憶體內容如下:
</p>


<div class="figure">
<p><img src="example2.png">
</p>
</div>

<p>
首先剛開始的指令 9 是 2-byte 指令，因此我們必須將 13 當作其參數一起考量，而 [ 9, 13 ] 則代表著
</p>

<pre class="example">
R0 = memory[13] = 6
</pre>



<div class="figure">
<p><img src="example3.png">
</p>
</div>

<p>
而接下來的命令 10 同樣也是 2-byte 指令，因此必須將 3 當作其參數一起來看，[ 10, 3
] 則代表著
</p>

<pre class="example">
R1 = memory[3] = 3
</pre>



<div class="figure">
<p><img src="example4.png">
</p>
</div>

<p>
再接下來我們碰到了 1 則是 1-byte 命令，因此目前運作如下
</p>

<pre class="example">
R0 = R0 + R1 = 6 + 3 = 9
</pre>



<div class="figure">
<p><img src="example5.png">
</p>
</div>

<p>
再接下來我們碰到了 3 是 1-byte 命令，因此目前運作如下
</p>

<pre class="example">
R0 = R0 + 1 = 9 + 1 = 10
</pre>



<div class="figure">
<p><img src="example6.png">
</p>
</div>

<p>
在接著則是命令 11，這是一個 2-byte 命令，會將 R0 的內容寫入到其參數 (9) 所在的記
憶體位址，因此經過這個命令後，記憶體變成如下
</p>


<div class="figure">
<p><img src="example7.png">
</p>
</div>

<p>
最後一個遇到的命令是 8 代表將下一個資料印出來，因此我們就會看到 10 顯示在終端機
上了，也就是說，剛剛的程式進行了以下的運作
</p>

<div class="org-src-container">
<pre class="src src-python">R0 = <span style="color: #ccaaff;">6</span>
R1 = <span style="color: #ccaaff;">3</span>
R0 = R0 + R1
R0 = R0 + <span style="color: #ccaaff;">1</span>
<span style="color: #aaffaa;">print</span> R0
</pre>
</div>
</div>
</div>

<div id="outline-container-org7c6e5cd" class="outline-2">
<h2 id="org7c6e5cd">建立我們的 Clojure/Clojurescript 專案</h2>
<div class="outline-text-2" id="text-org7c6e5cd">
<p>
了解到了 4917 的運作模式以及指令集後，我們可以開始寫程式囉，首先使用 <code>lein</code> 建立我們的專案
</p>

<pre class="example">
coldnew@Rosia ~ $ lein new emulator-4917
</pre>

<p>
由於預設的 lein 專案缺少很多東西，因此我們必須一一添加 (或是你可以使用比較合適的
樣板），首先在 <code>project.clj</code> 裡面修改部分設定成如下
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #aaffaa;">defproject</span> <span style="color: #aaccff;">emulator-4917</span> <span style="color: #aadddd;">"0.1.0-SNAPSHOT"</span>
  <span style="color: #5f5f5f; font-style: italic;">;; </span><span style="color: #9ac; font-style: italic;">skip ...</span>

  <span style="color: #ccaaff;">:source-paths</span> <span style="color: #81d4fa;">[</span><span style="color: #aadddd;">"src"</span><span style="color: #81d4fa;">]</span>

  <span style="color: #ccaaff;">:dependencies</span> <span style="color: #81d4fa;">[</span><span style="color: #aaccff;">[</span><span style="color: #fff59d;">org.clojure</span>/clojure <span style="color: #aadddd;">"1.7.0"</span><span style="color: #aaccff;">]</span>
                 <span style="color: #aaccff;">[</span><span style="color: #fff59d;">org.clojure</span>/clojurescript <span style="color: #aadddd;">"0.0-3308"</span> <span style="color: #ccaaff;">:scope</span> <span style="color: #aadddd;">"provided"</span><span style="color: #aaccff;">]</span><span style="color: #81d4fa;">]</span>

  <span style="color: #ccaaff;">:plugins</span> <span style="color: #81d4fa;">[</span><span style="color: #aaccff;">[</span>lein-cljsbuild <span style="color: #aadddd;">"1.0.6"</span><span style="color: #aaccff;">]</span><span style="color: #81d4fa;">]</span>

  <span style="color: #ccaaff;">:min-lein-version</span> <span style="color: #aadddd;">"2.5.1"</span>

  <span style="color: #ccaaff;">:cljsbuild</span> <span style="color: #81d4fa;">{</span><span style="color: #ccaaff;">:builds</span>
              <span style="color: #aaccff;">[</span><span style="color: #aaeecc;">{</span>
                <span style="color: #ccaaff;">:source-paths</span> <span style="color: #ccaaff;">[</span><span style="color: #aadddd;">"src"</span><span style="color: #ccaaff;">]</span>
                <span style="color: #ccaaff;">:compiler</span> <span style="color: #ccaaff;">{</span><span style="color: #ccaaff;">:output-to</span> <span style="color: #aadddd;">"target/emulator-4917.js"</span>
                           <span style="color: #ccaaff;">:output-dir</span> <span style="color: #aadddd;">"target"</span>
                           <span style="color: #ccaaff;">:source-map</span> <span style="color: #aadddd;">"target/emulator-4917.js.map"</span>
                           <span style="color: #ccaaff;">:target</span> <span style="color: #ccaaff;">:nodejs</span>
                           <span style="color: #ccaaff;">:optimizations</span> <span style="color: #ccaaff;">:none</span>
                           <span style="color: #ccaaff;">:pretty-print</span> <span style="color: #ccaaff;">true</span><span style="color: #ccaaff;">}</span><span style="color: #aaeecc;">}</span><span style="color: #aaccff;">]</span><span style="color: #81d4fa;">}</span>
  <span style="color: #ccaaff;">:aot</span> <span style="color: #81d4fa;">[</span>emulator-4917.core<span style="color: #81d4fa;">]</span>
  <span style="color: #ccaaff;">:main</span> emulator-4917.core<span style="color: #aadddd;">)</span>
</pre>
</div>

<div class="alert">
<p>
請注意到由於本篇文章將使用 Clojure 1.7 的新功能 <a href="http://dev.clojure.org/display/design/Reader+Conditionals" target="_blank" rel="noopener">Reader Conditionals</a> ，因此
Clojure/Clojurescript 版本必須依照以上設定或選用更高版本，並且 <code>lein</code> 版本也必須
升級到最新版 2.5.1.
</p>

</div>

<p>
而在這個 <code>project.clj</code> 裡面，由於我們為了讓 Clojurescript 編譯速度加快，我們採用
了 <code>none</code> 最佳化，因此必須另外增加一個 <code>run.js</code> 來協助執行編譯出來的 javascript，
其內容如下
</p>

<div class="org-src-container">
<pre class="src src-js"><span style="color: #5f5f5f; font-style: italic;">// </span><span style="color: #9ac; font-style: italic;">http://stackoverflow.com/questions/25803420/how-to-compile-clojurescript-to-nodejs</span>
<span style="color: #aaffaa;">try</span> <span style="color: #aadddd;">{</span>
    require<span style="color: #81d4fa;">(</span><span style="color: #aadddd;">"source-map-support"</span><span style="color: #81d4fa;">)</span>.install<span style="color: #81d4fa;">()</span>;
<span style="color: #aadddd;">}</span> <span style="color: #aaffaa;">catch</span><span style="color: #aadddd;">(</span>err<span style="color: #aadddd;">)</span> <span style="color: #aadddd;">{</span>
<span style="color: #aadddd;">}</span>
require<span style="color: #aadddd;">(</span><span style="color: #aadddd;">"./target/goog/bootstrap/nodejs.js"</span><span style="color: #aadddd;">)</span>;
require<span style="color: #aadddd;">(</span><span style="color: #aadddd;">"./target/emulator-4917.js"</span><span style="color: #aadddd;">)</span>;
require<span style="color: #aadddd;">(</span><span style="color: #aadddd;">"./target/emulator_4917/core"</span><span style="color: #aadddd;">)</span>;
emulator_4917.core._main<span style="color: #aadddd;">(</span>process.argv<span style="color: #81d4fa;">[</span><span style="color: #ccaaff;">2</span><span style="color: #81d4fa;">]</span><span style="color: #aadddd;">)</span>; <span style="color: #5f5f5f; font-style: italic;">// </span><span style="color: #9ac; font-style: italic;">passing argument</span>
</pre>
</div>

<p>
另外，我們必須將 lein 產生出來的 <code>src/emulator_4917/core.clj</code> 改名為
<code>src/emulator_4917/core.cljc</code> 這樣我們才能夠順利使用 <a href="http://dev.clojure.org/display/design/Reader%2BConditionals" target="_blank" rel="noopener">Reader Conditionals</a> 這個功
能。
</p>
</div>
</div>

<div id="outline-container-org8a18b7d" class="outline-2">
<h2 id="org8a18b7d">建立初始樣板</h2>
<div class="outline-text-2" id="text-org8a18b7d">
<p>
我們首先先建立我們程式的雛形，讓其根據不同條件選擇要載入的 library 或是預先執行的方法，我們修改 <code>src/emulator_4917/core.cljc</code> 成以下
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #aaffaa;">ns</span> <span style="color: #fff59d;">emulator-4917.core</span>
  <span style="color: #81d4fa;">(</span><span style="color: #ccaaff;">:require</span> #?<span style="color: #aaccff;">(</span><span style="color: #ccaaff;">:cljs</span> <span style="color: #aaeecc;">[</span>cljs.nodejs <span style="color: #ccaaff;">:as</span> nodejs<span style="color: #aaeecc;">]</span><span style="color: #aaccff;">)</span>
            #?<span style="color: #aaccff;">(</span><span style="color: #ccaaff;">:cljs</span> <span style="color: #aaeecc;">[</span>goog.crypt <span style="color: #ccaaff;">:as</span> gcrypt<span style="color: #aaeecc;">]</span><span style="color: #aaccff;">)</span>
            <span style="color: #aaccff;">[</span>clojure.string <span style="color: #ccaaff;">:as</span> str<span style="color: #aaccff;">]</span><span style="color: #81d4fa;">)</span>
  #?<span style="color: #81d4fa;">(</span><span style="color: #ccaaff;">:clj</span> <span style="color: #aaccff;">(</span><span style="color: #ccaaff;">:gen-class</span><span style="color: #aaccff;">)</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>

<span style="color: #5f5f5f; font-style: italic;">;; </span><span style="color: #9ac; font-style: italic;">enable *print-fn* in clojurescript</span>
#?<span style="color: #aadddd;">(</span><span style="color: #ccaaff;">:cljs</span> <span style="color: #81d4fa;">(</span>enable-console-print!<span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>

<span style="color: #aadddd;">(</span><span style="color: #aaffaa;">defn</span> <span style="color: #aaccff;">-main</span> <span style="color: #81d4fa;">[</span>&amp; args<span style="color: #81d4fa;">]</span>
  <span style="color: #81d4fa;">(</span><span style="color: #aaffaa;">let</span> <span style="color: #aaccff;">[</span>arg1 <span style="color: #aaeecc;">(</span>nth args <span style="color: #ccaaff;">0</span><span style="color: #aaeecc;">)</span><span style="color: #aaccff;">]</span>
    <span style="color: #aaccff;">(</span><span style="color: #aaffaa;">if</span> arg1
      <span style="color: #aaeecc;">(</span>println <span style="color: #aadddd;">"</span><span style="color: #ff3333; font-weight: bold;">TODO</span><span style="color: #aadddd;">: read binary file and execute it."</span><span style="color: #aaeecc;">)</span>
      <span style="color: #aaeecc;">(</span>println <span style="color: #aadddd;">"Error: Please specify filename."</span><span style="color: #aaeecc;">)</span><span style="color: #aaccff;">)</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>

<span style="color: #5f5f5f; font-style: italic;">;; </span><span style="color: #9ac; font-style: italic;">setup node.js starter point</span>
#?<span style="color: #aadddd;">(</span><span style="color: #ccaaff;">:cljs</span> <span style="color: #81d4fa;">(</span><span style="color: #aaffaa;">set!</span> <span style="color: #aaccff;">*main-cli-fn*</span> -main<span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>

<p>
在上面的樣板中，被 <code>#?()﻿</code> 所包圍的東西會根據不同狀況被解析，這就是 Clojure 1.7
的 <a href="http://dev.clojure.org/display/design/Reader%2BConditionals%EF%BC%8C%E4%B8%80%E6%AC%A1%E5%AF%A6%E7%8F%BE" target="_blank" rel="noopener">Reader Conditionals</a> 功能，我們可以用以下範例來了解他的使用，下面的程式會根據
目前是編譯給 Clojure 還是 Clojurescript 來選擇要執行的項目，如果你今天是用在
Clojure (JVM)上，則其會顯示 <code>Hi, Clojure</code> ，反之若是執行在 Clojurescript
(Node.js, browser) 上，則會顯示 <code>Hi, Clojurescript</code> 。
</p>

<div class="org-src-container">
<pre class="src src-clojure">#?<span style="color: #aadddd;">(</span><span style="color: #ccaaff;">:clj</span>
   <span style="color: #81d4fa;">(</span>println <span style="color: #aadddd;">"Hi, Clojure"</span><span style="color: #81d4fa;">)</span>
   <span style="color: #ccaaff;">:cljs</span>
   <span style="color: #81d4fa;">(</span>.log <span style="color: #fff59d;">js</span>/console <span style="color: #aadddd;">"Hi, Clojurescript"</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org9f02a97" class="outline-2">
<h2 id="org9f02a97">讀取二進制檔案並解析</h2>
<div class="outline-text-2" id="text-org9f02a97">
<p>
為了讓這個模擬器更像模擬器，我們讓他讀取二進制檔案到 memory 去來模擬 CPU 載入
ROM 動作，讀取完成後則將資料變成 Clojure 的陣列，好方便之後的程式運作，也就是說，
假設欲讀取的二進制文件內容如下
</p>

<pre class="example">
coldnew@Rosia ~/emulator-4917 $ hexdump -C examples/bell.bin | head -n 1
00000000  77 70                                             |wp|
</pre>

<p>
我們要想辦法讀取這份文件，並產生 <code>[7, 7, 7, 0]</code> 這樣的陣列才行，而由於牽扯到
了讀取檔案的運作，這部份一定是要分開 Clojure 與 Clojurescript 的實作。
</p>

<p>
我們先談談在 Clojure 讀取檔案的作法，理論上我們可以使用 <a href="https://clojuredocs.org/clojure.core/slurp" target="_blank" rel="noopener">slurp</a> 去讀取檔案，但是由
於 slurp 會將讀取到的內容根據編碼來轉換，因此不適合本文的應用，只好使用 Java 的
方式來讀取二進制檔案囉，我們建立一個 <code>parse-binary-file</code> 函式來讀取檔案並且轉換
成 byte-array。
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #aaffaa;">defn</span> <span style="color: #aaccff;">parse-binary-file</span>
  <span style="color: #97abc6; font-style: italic;">"Clojure method to read binary file and convert to byte-array."</span>
  <span style="color: #81d4fa;">[</span>file<span style="color: #81d4fa;">]</span>
  <span style="color: #81d4fa;">(</span><span style="color: #aaffaa;">with-open</span> <span style="color: #aaccff;">[</span>out <span style="color: #aaeecc;">(</span>java.io.ByteArrayOutputStream.<span style="color: #aaeecc;">)</span><span style="color: #aaccff;">]</span>
    <span style="color: #aaccff;">(</span><span style="color: #fff59d;">clojure.java.io</span>/copy <span style="color: #aaeecc;">(</span><span style="color: #fff59d;">clojure.java.io</span>/input-stream file<span style="color: #aaeecc;">)</span> out<span style="color: #aaccff;">)</span>
    <span style="color: #aaccff;">(</span>.toByteArray out<span style="color: #aaccff;">)</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>

<p>
而在 Clojurescript 中，因為我們是執行在 Node.js 環境上，可以使用 Node.js 的
<a href="https://nodejs.org/api/fs.html#fs_fs_readfilesync_filename_options" target="_blank" rel="noopener">fs.readFileSync()</a> 方法來讀取二進制檔案，讀取完成後在用 google Closure library 裡面
的 <a href="http://google.github.io/closure-library/api/source/closure/goog/crypt/crypt.js.src.html#l32" target="_blank" rel="noopener">goog.crypt.stringToByteArray</a> 將其轉換成 byte-array.
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #aaffaa;">defn</span> <span style="color: #aaccff;">parse-binary-file</span>
  <span style="color: #97abc6; font-style: italic;">"Clojurescript method to read binary file and convert to byte-array."</span>
  <span style="color: #81d4fa;">[</span>file<span style="color: #81d4fa;">]</span>
  <span style="color: #81d4fa;">(</span><span style="color: #aaffaa;">-&gt;</span>  <span style="color: #aaccff;">(</span><span style="color: #fff59d;">nodejs</span>/require <span style="color: #aadddd;">"fs"</span><span style="color: #aaccff;">)</span>
       <span style="color: #aaccff;">(</span>.readFileSync file <span style="color: #aadddd;">"binary"</span><span style="color: #aaccff;">)</span>
       .toString
       <span style="color: #fff59d;">gcrypt</span>/stringToByteArray<span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>

<p>
最後，將這兩部份的程式碼整合起來，就會變成如下
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #aaffaa;">defn</span> <span style="color: #aaccff;">parse-binary-file</span>
  <span style="color: #81d4fa;">[</span>file<span style="color: #81d4fa;">]</span>
  #?<span style="color: #81d4fa;">(</span><span style="color: #ccaaff;">:clj</span>
     <span style="color: #aaccff;">(</span><span style="color: #aaffaa;">with-open</span> <span style="color: #aaeecc;">[</span>out <span style="color: #ccaaff;">(</span>java.io.ByteArrayOutputStream.<span style="color: #ccaaff;">)</span><span style="color: #aaeecc;">]</span>
       <span style="color: #aaeecc;">(</span><span style="color: #fff59d;">clojure.java.io</span>/copy <span style="color: #ccaaff;">(</span><span style="color: #fff59d;">clojure.java.io</span>/input-stream file<span style="color: #ccaaff;">)</span> out<span style="color: #aaeecc;">)</span>
       <span style="color: #aaeecc;">(</span>.toByteArray out<span style="color: #aaeecc;">)</span><span style="color: #aaccff;">)</span>
     <span style="color: #ccaaff;">:cljs</span>
     <span style="color: #aaccff;">(</span><span style="color: #aaffaa;">-&gt;</span>  <span style="color: #aaeecc;">(</span><span style="color: #fff59d;">nodejs</span>/require <span style="color: #aadddd;">"fs"</span><span style="color: #aaeecc;">)</span>
          <span style="color: #aaeecc;">(</span>.readFileSync file <span style="color: #aadddd;">"binary"</span><span style="color: #aaeecc;">)</span>
          .toString
          <span style="color: #fff59d;">gcrypt</span>/stringToByteArray<span style="color: #aaccff;">)</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>

<p>
完成了 <code>parse-binary-file</code> 後，由於這樣產生出來的陣列內容為 <code>[ 0x77, 0x70 ]</code> 和
我們期望的 <code>[ 7, 7, 7, 0 ]</code> 有所落差，因此我們需要另外一個方式將 0x77 變成 [ 7,
7 ] 這樣的組合，我們可以用以下函式來達到這件事情
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #aaffaa;">defn</span> <span style="color: #aaccff;">to-4bit-array</span>
  <span style="color: #97abc6; font-style: italic;">"Convert 0xf4 to [f 4]"</span>
  <span style="color: #81d4fa;">[</span>s<span style="color: #81d4fa;">]</span>
  <span style="color: #81d4fa;">(</span><span style="color: #aaffaa;">let</span> <span style="color: #aaccff;">[</span>h <span style="color: #aaeecc;">(</span>bit-and <span style="color: #ccaaff;">(</span>bit-shift-right s <span style="color: #ccaaff;">4</span><span style="color: #ccaaff;">)</span> <span style="color: #ccaaff;">0x0f</span><span style="color: #aaeecc;">)</span> <span style="color: #9ac; font-style: italic;">; (0xf4 &gt;&gt; 4) &amp; 0x0f   =&gt; f</span>
        l <span style="color: #aaeecc;">(</span>bit-and s <span style="color: #ccaaff;">0x0f</span><span style="color: #aaeecc;">)</span><span style="color: #aaccff;">]</span>                    <span style="color: #9ac; font-style: italic;">; 0xf4 &amp; 0x0f =&gt; 4</span>
    <span style="color: #aaccff;">[</span>h l<span style="color: #aaccff;">]</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>

<p>
接著，我們使用 <a href="https://clojuredocs.org/clojure.core/map" target="_blank" rel="noopener">map</a> 將 <code>to-4bit-array</code> 套用在 <code>parse-binary-file</code> 得到的結果上
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span>map to-4bit-array <span style="color: #81d4fa;">(</span>parse-binary-file file<span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span> <span style="color: #9ac; font-style: italic;">; =&gt; [ [7, 7] [7, 0] ]</span>
</pre>
</div>

<p>
這樣得到的結果仍舊不是我們想要的，因為他變成了多維陣列，因此我們使用 <a href="https://clojuredocs.org/clojure.core/flatten" target="_blank" rel="noopener">flatten</a> 將
多維陣列變成一維的
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span>flatten <span style="color: #81d4fa;">[</span> <span style="color: #aaccff;">[</span><span style="color: #ccaaff;">7</span>, <span style="color: #ccaaff;">7</span><span style="color: #aaccff;">]</span> <span style="color: #aaccff;">[</span><span style="color: #ccaaff;">7</span>, <span style="color: #ccaaff;">0</span><span style="color: #aaccff;">]</span> <span style="color: #81d4fa;">]</span><span style="color: #aadddd;">)</span> <span style="color: #9ac; font-style: italic;">; =&gt; (7, 7, 7, 0)</span>
</pre>
</div>

<p>
到此為止，我們完成了讀取二進制檔案並將其變成命令陣列的功能，將其合起來就變成
<code>parse-rom</code> ，我們將用他來讀取二進制檔案並傳送命令陣列給 4917 模擬器處理。
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #aaffaa;">defn</span> <span style="color: #aaccff;">parse-rom</span> <span style="color: #81d4fa;">[</span>file<span style="color: #81d4fa;">]</span>
  <span style="color: #81d4fa;">(</span>flatten
   <span style="color: #aaccff;">(</span>map to-4bit-array <span style="color: #aaeecc;">(</span>parse-binary-file file<span style="color: #aaeecc;">)</span><span style="color: #aaccff;">)</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3575366" class="outline-2">
<h2 id="org3575366">建立 4917 這顆 CPU</h2>
<div class="outline-text-2" id="text-org3575366">
<p>
在 Clojure 這種函數式的語言中我們要怎樣定義一個 CPU 呢？最簡單的方式就是透過
<code>defrecord</code> 去創建這個 CPU 的狀態，以 4917 來說，他共有四個暫存器(R0, R1, PC, IS)
以及 16 個 4-bit 的記憶體空間，因此我們可以這樣定義他的 State.
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #aaffaa;">defrecord</span> <span style="color: #fff59d;">State</span> <span style="color: #81d4fa;">[</span>memory r0 r1 pc is<span style="color: #81d4fa;">]</span><span style="color: #aadddd;">)</span>
</pre>
</div>

<p>
這樣子我們就可以透過 State 來創建我們的 CPU 狀態，舉例來說如下
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span>-&gt;State <span style="color: #81d4fa;">(</span>vec <span style="color: #aaccff;">(</span>repeat <span style="color: #ccaaff;">16</span> <span style="color: #ccaaff;">0</span><span style="color: #aaccff;">)</span><span style="color: #81d4fa;">)</span> <span style="color: #ccaaff;">0</span> <span style="color: #ccaaff;">0</span> <span style="color: #ccaaff;">0</span> <span style="color: #ccaaff;">0</span><span style="color: #aadddd;">)</span>
<span style="color: #5f5f5f; font-style: italic;">;; </span><span style="color: #9ac; font-style: italic;">=&gt; #user.State{:memory [0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0], :r0 0, :r1 0, :pc 0, :is 0}</span>
</pre>
</div>

<p>
但是直接用 State 創建 CPU 其實不是很優雅的方式，我們可以將他綁到我們自制的
<code>make-cpu</code> 函式去，讓建立 CPU 更簡單
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #aaffaa;">defn</span> <span style="color: #aaccff;">make-cpu</span>
  <span style="color: #81d4fa;">(</span><span style="color: #aaccff;">[</span>&amp; <span style="color: #aaeecc;">{</span><span style="color: #ccaaff;">:keys</span> <span style="color: #ccaaff;">[</span>memory r0 r1 pc is<span style="color: #ccaaff;">]</span>
       <span style="color: #ccaaff;">:or</span> <span style="color: #ccaaff;">{</span>r0 <span style="color: #ccaaff;">0</span>
            r1 <span style="color: #ccaaff;">0</span>
            pc <span style="color: #ccaaff;">0</span>
            is <span style="color: #ccaaff;">0</span><span style="color: #ccaaff;">}</span><span style="color: #aaeecc;">}</span><span style="color: #aaccff;">]</span>
   <span style="color: #aaccff;">(</span>State. <span style="color: #aaeecc;">(</span>vec <span style="color: #ccaaff;">(</span>take <span style="color: #ccaaff;">16</span> <span style="color: #fff59d;">(</span>concat memory <span style="color: #ff8888;">(</span>repeat <span style="color: #ccaaff;">16</span> <span style="color: #ccaaff;">0</span><span style="color: #ff8888;">)</span><span style="color: #fff59d;">)</span><span style="color: #ccaaff;">)</span><span style="color: #aaeecc;">)</span> r0 r1 pc is<span style="color: #aaccff;">)</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>

<p>
透過這樣的 <code>make-cpu</code> 函式，假設我們要創建一個預設 r0 為 5, 記憶體內容為 [5, 2,
2] 的 CPU，則可以這樣作
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span>make-cpu <span style="color: #ccaaff;">:memory</span> <span style="color: #81d4fa;">[</span><span style="color: #ccaaff;">5</span>, <span style="color: #ccaaff;">2</span>, <span style="color: #ccaaff;">2</span><span style="color: #81d4fa;">]</span> <span style="color: #ccaaff;">:r0</span> <span style="color: #ccaaff;">5</span><span style="color: #aadddd;">)</span>
<span style="color: #5f5f5f; font-style: italic;">;; </span><span style="color: #9ac; font-style: italic;">=&gt; #user.State{:memory [5 2 2 0 0 0 0 0 0 0 0 0 0 0 0 0], :r0 5, :r1 0, :pc 0, :is 0}</span>
</pre>
</div>

<p>
有了建立 CPU 當前狀態的函式後，是時候去定義這 16 個指令集了
</p>
</div>
</div>

<div id="outline-container-org286d59d" class="outline-2">
<h2 id="org286d59d">定義指令集</h2>
<div class="outline-text-2" id="text-org286d59d">
<p>
前面說到了 4917 這顆 CPU 共有 16 種指令 (0 ~ 15)，因此我們來一個一個定義吧，
</p>
</div>

<div id="outline-container-org29cf8fe" class="outline-3">
<h3 id="org29cf8fe">指令 0 : 結束程式</h3>
<div class="outline-text-3" id="text-org29cf8fe">
<p>
首先定義指令 0，當 4917 接收到這個命令後，會結束程式。結束程式的方式，在 Clojure 中我們可以透過
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #fff59d;">System</span>/exit <span style="color: #ccaaff;">0</span><span style="color: #aadddd;">)</span>
</pre>
</div>

<p>
來達成，而在 Node.js 中，則是可以使用 process.exit(0) 來進行
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span>.exit <span style="color: #fff59d;">nodejs</span>/process <span style="color: #ccaaff;">0</span><span style="color: #aadddd;">)</span>
</pre>
</div>

<p>
因此我們的指令 0 就變成了這個樣子
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #aaffaa;">defn</span> <span style="color: #aaccff;">cmd0</span>
  <span style="color: #97abc6; font-style: italic;">"cmd 0: exit application."</span>
  <span style="color: #81d4fa;">[</span><span style="color: #aaccff;">{</span><span style="color: #ccaaff;">:keys</span> <span style="color: #aaeecc;">[</span>memory r0 r1 pc is<span style="color: #aaeecc;">]</span><span style="color: #aaccff;">}</span><span style="color: #81d4fa;">]</span>
  <span style="color: #81d4fa;">(</span>println <span style="color: #aadddd;">"Terminate application."</span><span style="color: #81d4fa;">)</span>
  #?<span style="color: #81d4fa;">(</span><span style="color: #ccaaff;">:clj</span>
     <span style="color: #aaccff;">(</span><span style="color: #fff59d;">System</span>/exit <span style="color: #ccaaff;">0</span><span style="color: #aaccff;">)</span>
     <span style="color: #ccaaff;">:cljs</span>
     <span style="color: #aaccff;">(</span>.exit <span style="color: #fff59d;">nodejs</span>/process <span style="color: #ccaaff;">0</span><span style="color: #aaccff;">)</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org344db94" class="outline-3">
<h3 id="org344db94">指令 1 : R0 = R0 + R1</h3>
<div class="outline-text-3" id="text-org344db94">
<p>
指令 1 是我們第一個實作指令，首先我們將目前 CPU 的狀態傳送到指令 1 中，再根據需
求透過 <code>make-cpu</code> 建立新的狀態並回傳，由於 PC (Program Counter) 在執行完此命令後
應該要指向下一個記憶體位址，因此要記得增加 PC 的數值，讓 CPU 可以順利指向下一個
位址。
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #aaffaa;">defn</span> <span style="color: #aaccff;">cmd1</span>
  <span style="color: #97abc6; font-style: italic;">"cmd 1: R0 = R0 + R1"</span>
  <span style="color: #81d4fa;">[</span><span style="color: #aaccff;">{</span><span style="color: #ccaaff;">:keys</span> <span style="color: #aaeecc;">[</span>memory r0 r1 pc is<span style="color: #aaeecc;">]</span><span style="color: #aaccff;">}</span><span style="color: #81d4fa;">]</span>
  <span style="color: #81d4fa;">(</span>make-cpu
   <span style="color: #ccaaff;">:memory</span> memory <span style="color: #ccaaff;">:r0</span> <span style="color: #aaccff;">(</span>+ r0 r1<span style="color: #aaccff;">)</span> <span style="color: #ccaaff;">:r1</span> r1 <span style="color: #ccaaff;">:pc</span> <span style="color: #aaccff;">(</span>inc pc<span style="color: #aaccff;">)</span> <span style="color: #ccaaff;">:is</span> <span style="color: #ccaaff;">1</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgb2e68a6" class="outline-3">
<h3 id="orgb2e68a6">指令 2 : R0 = R0 - R1</h3>
<div class="outline-text-3" id="text-orgb2e68a6">
<p>
指令 2 和指令 1 非常相似，唯一的差別在於 :r0 存放的內容是 r0 - r1 的結果。
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #aaffaa;">defn</span> <span style="color: #aaccff;">cmd2</span>
  <span style="color: #97abc6; font-style: italic;">"cmd 2: R0 = R0 - R1"</span>
  <span style="color: #81d4fa;">[</span><span style="color: #aaccff;">{</span><span style="color: #ccaaff;">:keys</span> <span style="color: #aaeecc;">[</span>memory r0 r1 pc is<span style="color: #aaeecc;">]</span><span style="color: #aaccff;">}</span><span style="color: #81d4fa;">]</span>
  <span style="color: #81d4fa;">(</span>make-cpu
   <span style="color: #ccaaff;">:memory</span> memory <span style="color: #ccaaff;">:r0</span> <span style="color: #aaccff;">(</span>- r0 r1<span style="color: #aaccff;">)</span> <span style="color: #ccaaff;">:r1</span> r1 <span style="color: #ccaaff;">:pc</span> <span style="color: #aaccff;">(</span>inc pc<span style="color: #aaccff;">)</span> <span style="color: #ccaaff;">:is</span> <span style="color: #ccaaff;">2</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgae7d6a7" class="outline-3">
<h3 id="orgae7d6a7">指令 3 : R0 = R0 + 1</h3>
<div class="outline-text-3" id="text-orgae7d6a7">
<p>
指令 3 使用類似指令 1 的實作，我們使用 <code>(inc r0)</code> 來進行 r0 + 1 的動作，當然，你
也可以使用 <code>(+ r0 1)</code> 。
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #aaffaa;">defn</span> <span style="color: #aaccff;">cmd3</span>
  <span style="color: #97abc6; font-style: italic;">"cmd 3: R0 = R0 + 1"</span>
  <span style="color: #81d4fa;">[</span><span style="color: #aaccff;">{</span><span style="color: #ccaaff;">:keys</span> <span style="color: #aaeecc;">[</span>memory r0 r1 pc is<span style="color: #aaeecc;">]</span><span style="color: #aaccff;">}</span><span style="color: #81d4fa;">]</span>
  <span style="color: #81d4fa;">(</span>make-cpu
   <span style="color: #ccaaff;">:memory</span> memory <span style="color: #ccaaff;">:r0</span> <span style="color: #aaccff;">(</span>inc r0<span style="color: #aaccff;">)</span> <span style="color: #ccaaff;">:r1</span> r1 <span style="color: #ccaaff;">:pc</span> <span style="color: #aaccff;">(</span>inc pc<span style="color: #aaccff;">)</span> <span style="color: #ccaaff;">:is</span> <span style="color: #ccaaff;">3</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgf8e4b1b" class="outline-3">
<h3 id="orgf8e4b1b">指令 4 : R1 = R1 + 1</h3>
<div class="outline-text-3" id="text-orgf8e4b1b">
<p>
指令 4 和指令 3 非常相似，只是將目標暫存器從 r0 改成 r1 而已。
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #aaffaa;">defn</span> <span style="color: #aaccff;">cmd4</span>
  <span style="color: #97abc6; font-style: italic;">"cmd 4: R1 = R1 + 1"</span>
  <span style="color: #81d4fa;">[</span><span style="color: #aaccff;">{</span><span style="color: #ccaaff;">:keys</span> <span style="color: #aaeecc;">[</span>memory r0 r1 pc is<span style="color: #aaeecc;">]</span><span style="color: #aaccff;">}</span><span style="color: #81d4fa;">]</span>
  <span style="color: #81d4fa;">(</span>make-cpu
   <span style="color: #ccaaff;">:memory</span> memory <span style="color: #ccaaff;">:r0</span> r0 <span style="color: #ccaaff;">:r1</span> <span style="color: #aaccff;">(</span>inc r1<span style="color: #aaccff;">)</span> <span style="color: #ccaaff;">:pc</span> <span style="color: #aaccff;">(</span>inc pc<span style="color: #aaccff;">)</span> <span style="color: #ccaaff;">:is</span> <span style="color: #ccaaff;">4</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1f15302" class="outline-3">
<h3 id="org1f15302">指令 5 : R0 = R0 -1</h3>
<div class="outline-text-3" id="text-org1f15302">
<p>
使用類似指令 3 的實作模式，我們使用 <code>(dec r0)</code> 來進行 r0 - 1 的動作，當然，你
也可以使用 <code>(- r0 1)</code> 。
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #aaffaa;">defn</span> <span style="color: #aaccff;">cmd5</span>
  <span style="color: #97abc6; font-style: italic;">"cmd 5: R0 = R0 - 1"</span>
  <span style="color: #81d4fa;">[</span><span style="color: #aaccff;">{</span><span style="color: #ccaaff;">:keys</span> <span style="color: #aaeecc;">[</span>memory r0 r1 pc is<span style="color: #aaeecc;">]</span><span style="color: #aaccff;">}</span><span style="color: #81d4fa;">]</span>
  <span style="color: #81d4fa;">(</span>make-cpu
   <span style="color: #ccaaff;">:memory</span> memory <span style="color: #ccaaff;">:r0</span> <span style="color: #aaccff;">(</span>dec r0<span style="color: #aaccff;">)</span> <span style="color: #ccaaff;">:r1</span> r1 <span style="color: #ccaaff;">:pc</span> <span style="color: #aaccff;">(</span>inc pc<span style="color: #aaccff;">)</span> <span style="color: #ccaaff;">:is</span> <span style="color: #ccaaff;">5</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge1623c4" class="outline-3">
<h3 id="orge1623c4">指令 6 : R1 = R1 -1</h3>
<div class="outline-text-3" id="text-orge1623c4">
<p>
指令 6 和指令 5 非常相似，只是將目標暫存器從 r0 改成 r1 而已。
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #aaffaa;">defn</span> <span style="color: #aaccff;">cmd6</span>
  <span style="color: #97abc6; font-style: italic;">"cmd 6: R1 = R1 - 1"</span>
  <span style="color: #81d4fa;">[</span><span style="color: #aaccff;">{</span><span style="color: #ccaaff;">:keys</span> <span style="color: #aaeecc;">[</span>memory r0 r1 pc is<span style="color: #aaeecc;">]</span><span style="color: #aaccff;">}</span><span style="color: #81d4fa;">]</span>
  <span style="color: #81d4fa;">(</span>make-cpu
   <span style="color: #ccaaff;">:memory</span> memory <span style="color: #ccaaff;">:r0</span> r0 <span style="color: #ccaaff;">:r1</span> <span style="color: #aaccff;">(</span>dec r1<span style="color: #aaccff;">)</span> <span style="color: #ccaaff;">:pc</span> <span style="color: #aaccff;">(</span>inc pc<span style="color: #aaccff;">)</span> <span style="color: #ccaaff;">:is</span> <span style="color: #ccaaff;">6</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orga49c7c7" class="outline-3">
<h3 id="orga49c7c7">指令 7 : 響鈴</h3>
<div class="outline-text-3" id="text-orga49c7c7">
<p>
若 4917 真的有實體的話，指令 7 的功用應該是響蜂鳴器才對，這邊使用 <code>println</code> 將訊息印
出來作為替代，記得要增加 PC (Program Counter) 的數值。
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #aaffaa;">defn</span> <span style="color: #aaccff;">cmd7</span>
  <span style="color: #97abc6; font-style: italic;">"cmd 7: Ring bell"</span>
  <span style="color: #81d4fa;">[</span><span style="color: #aaccff;">{</span><span style="color: #ccaaff;">:keys</span> <span style="color: #aaeecc;">[</span>memory r0 r1 pc is<span style="color: #aaeecc;">]</span><span style="color: #aaccff;">}</span><span style="color: #81d4fa;">]</span>
  <span style="color: #81d4fa;">(</span>println <span style="color: #aadddd;">"Ring the bell!!"</span><span style="color: #81d4fa;">)</span>
  <span style="color: #81d4fa;">(</span>make-cpu
   <span style="color: #ccaaff;">:memory</span> memory <span style="color: #ccaaff;">:r0</span> r0 <span style="color: #ccaaff;">:r1</span> r1 <span style="color: #ccaaff;">:pc</span> <span style="color: #aaccff;">(</span>inc pc<span style="color: #aaccff;">)</span> <span style="color: #ccaaff;">:is</span> <span style="color: #ccaaff;">7</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgcc23f08" class="outline-3">
<h3 id="orgcc23f08">指令 8 : 印出 &lt;﻿data﻿&gt;</h3>
<div class="outline-text-3" id="text-orgcc23f08">
<p>
指令 8 就好玩一點點了，我們可以透過 <a href="https://clojuredocs.org/clojure.core/nth" target="_blank" rel="noopener">nth</a> 命令，取得記憶體陣列(memory)的某個位置的
數值
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span>nth <span style="color: #81d4fa;">[</span> a b c d <span style="color: #81d4fa;">]</span> <span style="color: #ccaaff;">2</span><span style="color: #aadddd;">)</span> <span style="color: #9ac; font-style: italic;">; =&gt; c</span>
</pre>
</div>

<p>
由於 &lt;﻿data﻿&gt; 是在 PC 指向的位址的下一格，因此印出 &lt;﻿data﻿&gt; 的方式就變成這樣
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span>println <span style="color: #81d4fa;">(</span>nth memory <span style="color: #aaccff;">(</span>inc pc<span style="color: #aaccff;">)</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>

<p>
了解這點後，我們就可以實作我們的 cmd8 了，要注意的事情是，這一類 2-byte 命令執行
完後，PC (Program Counter) 的數值是 <code>+2</code> ，而不是和指令 1 ~ 7 那樣的只是遞增 PC
數值而已。
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #aaffaa;">defn</span> <span style="color: #aaccff;">cmd8</span>
  <span style="color: #97abc6; font-style: italic;">"cmd 8: Print &lt;data&gt;"</span>
  <span style="color: #81d4fa;">[</span><span style="color: #aaccff;">{</span><span style="color: #ccaaff;">:keys</span> <span style="color: #aaeecc;">[</span>memory r0 r1 pc is<span style="color: #aaeecc;">]</span><span style="color: #aaccff;">}</span><span style="color: #81d4fa;">]</span>
  <span style="color: #81d4fa;">(</span>println <span style="color: #aaccff;">(</span>nth memory <span style="color: #aaeecc;">(</span>inc pc<span style="color: #aaeecc;">)</span><span style="color: #aaccff;">)</span><span style="color: #81d4fa;">)</span>
  <span style="color: #81d4fa;">(</span>make-cpu
   <span style="color: #ccaaff;">:memory</span> memory <span style="color: #ccaaff;">:r0</span> r0 <span style="color: #ccaaff;">:r1</span> r1 <span style="color: #ccaaff;">:pc</span> <span style="color: #aaccff;">(</span>+ pc <span style="color: #ccaaff;">2</span><span style="color: #aaccff;">)</span> <span style="color: #ccaaff;">:is</span> <span style="color: #ccaaff;">8</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org4ea0628" class="outline-3">
<h3 id="org4ea0628">指令 9 : 從位址 &lt;﻿data﻿&gt; 讀取資料存入 R0</h3>
<div class="outline-text-3" id="text-org4ea0628">
<p>
指令 9 中，我們必須知道 &lt;﻿data﻿&gt; 得內容後，再根據其數值去找尋記憶體位址的內容，並
將其存入 R0 中，而取得 &lt;﻿data﻿&gt; 內容的方式在指令 8 時說過了，使用 <a href="https://clojuredocs.org/clojure.core/nth" target="_blank" rel="noopener">nth</a> 可以達成
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span>nth memory <span style="color: #81d4fa;">(</span>inc pc<span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>

<p>
因此取得 &lt;﻿data﻿&gt; 後，我們可以再使用 <a href="https://clojuredocs.org/clojure.core/nth" target="_blank" rel="noopener">nth</a> 一次，來取得記憶體中第 &lt;﻿data﻿&gt; 個內容
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span>nth memory <span style="color: #81d4fa;">(</span>nth memory <span style="color: #aaccff;">(</span>inc pc<span style="color: #aaccff;">)</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>

<p>
因此最後的 cmd9 的實作就是這個樣子:
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #aaffaa;">defn</span> <span style="color: #aaccff;">cmd9</span>
  <span style="color: #97abc6; font-style: italic;">"cmd 9: Load value from &lt;data&gt; to R0"</span>
  <span style="color: #81d4fa;">[</span><span style="color: #aaccff;">{</span><span style="color: #ccaaff;">:keys</span> <span style="color: #aaeecc;">[</span>memory r0 r1 pc is<span style="color: #aaeecc;">]</span><span style="color: #aaccff;">}</span><span style="color: #81d4fa;">]</span>
  <span style="color: #81d4fa;">(</span>make-cpu
   <span style="color: #ccaaff;">:memory</span> memory <span style="color: #ccaaff;">:r1</span> r1 <span style="color: #ccaaff;">:pc</span> <span style="color: #aaccff;">(</span>+ pc <span style="color: #ccaaff;">2</span><span style="color: #aaccff;">)</span> <span style="color: #ccaaff;">:is</span> <span style="color: #ccaaff;">9</span>
   <span style="color: #ccaaff;">:r0</span> <span style="color: #aaccff;">(</span>nth memory <span style="color: #aaeecc;">(</span>nth memory <span style="color: #ccaaff;">(</span>inc pc<span style="color: #ccaaff;">)</span><span style="color: #aaeecc;">)</span><span style="color: #aaccff;">)</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgd8fd1a8" class="outline-3">
<h3 id="orgd8fd1a8">指令 10 : 從位址 &lt;﻿data﻿&gt; 讀取資料存入 R1</h3>
<div class="outline-text-3" id="text-orgd8fd1a8">
<p>
指令 10 和指令 9 很像，只是將目標轉換成 R1 而已，我們可以參考指令 9 進行實作。
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #aaffaa;">defn</span> <span style="color: #aaccff;">cmd10</span>
  <span style="color: #97abc6; font-style: italic;">"cmd 10: Load value from &lt;data&gt; to R1"</span>
  <span style="color: #81d4fa;">[</span><span style="color: #aaccff;">{</span><span style="color: #ccaaff;">:keys</span> <span style="color: #aaeecc;">[</span>memory r0 r1 pc is<span style="color: #aaeecc;">]</span><span style="color: #aaccff;">}</span><span style="color: #81d4fa;">]</span>
  <span style="color: #81d4fa;">(</span>make-cpu
   <span style="color: #ccaaff;">:memory</span> memory <span style="color: #ccaaff;">:r0</span> r0 <span style="color: #ccaaff;">:pc</span> <span style="color: #aaccff;">(</span>+ pc <span style="color: #ccaaff;">2</span><span style="color: #aaccff;">)</span> <span style="color: #ccaaff;">:is</span> <span style="color: #ccaaff;">10</span>
   <span style="color: #ccaaff;">:r1</span> <span style="color: #aaccff;">(</span>nth memory <span style="color: #aaeecc;">(</span>nth memory <span style="color: #ccaaff;">(</span>inc pc<span style="color: #ccaaff;">)</span><span style="color: #aaeecc;">)</span><span style="color: #aaccff;">)</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org653c9b2" class="outline-3">
<h3 id="org653c9b2">指令 11 : 將 R0 內容存入 位址 &lt;﻿data﻿&gt; 內</h3>
<div class="outline-text-3" id="text-org653c9b2">
<p>
現在我們知道了 <a href="https://clojuredocs.org/clojure.core/nth" target="_blank" rel="noopener">nth</a> 可以用來取得陣列中某一位置的內容，那我們要怎樣更新陣列的內容
呢?這時候就是 <a href="https://clojuredocs.org/clojure.core/assoc" target="_blank" rel="noopener">assoc</a> 出場的時候啦! <a href="https://clojuredocs.org/clojure.core/assoc" target="_blank" rel="noopener">assoc</a> 用在陣列的時候，可以根據你提供的位置以及
新的內容，產生出修改後的陣列
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span>assoc <span style="color: #81d4fa;">[</span><span style="color: #ccaaff;">0</span> <span style="color: #ccaaff;">0</span> <span style="color: #ccaaff;">0</span> <span style="color: #ccaaff;">0</span><span style="color: #81d4fa;">]</span> <span style="color: #ccaaff;">1</span> <span style="color: #ccaaff;">5</span><span style="color: #aadddd;">)</span> <span style="color: #9ac; font-style: italic;">; =&gt; [0 5 0 0]</span>
<span style="color: #aadddd;">(</span>assoc <span style="color: #81d4fa;">[</span><span style="color: #ccaaff;">0</span> <span style="color: #ccaaff;">0</span> <span style="color: #ccaaff;">0</span> <span style="color: #ccaaff;">0</span><span style="color: #81d4fa;">]</span> <span style="color: #ccaaff;">4</span> <span style="color: #ccaaff;">6</span><span style="color: #aadddd;">)</span> <span style="color: #9ac; font-style: italic;">; =&gt; [0 0 0 0 6]</span>
</pre>
</div>

<p>
而從前面的指令運作，我們知道 &lt;﻿data﻿&gt; 的內容是這樣取得的
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span>nth memory <span style="color: #81d4fa;">(</span>inc pc<span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>

<p>
將這兩個概念合併，就得到我們的指令 11 得實作囉～
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #aaffaa;">defn</span> <span style="color: #aaccff;">cmd11</span>
  <span style="color: #97abc6; font-style: italic;">"cmd 11: Store R0 into &lt;data&gt; position"</span>
  <span style="color: #81d4fa;">[</span><span style="color: #aaccff;">{</span><span style="color: #ccaaff;">:keys</span> <span style="color: #aaeecc;">[</span>memory r0 r1 pc is<span style="color: #aaeecc;">]</span><span style="color: #aaccff;">}</span><span style="color: #81d4fa;">]</span>
  <span style="color: #81d4fa;">(</span>make-cpu
   <span style="color: #ccaaff;">:memory</span> <span style="color: #aaccff;">(</span>assoc memory <span style="color: #aaeecc;">(</span>nth memory <span style="color: #ccaaff;">(</span>inc pc<span style="color: #ccaaff;">)</span><span style="color: #aaeecc;">)</span> r0<span style="color: #aaccff;">)</span>
   <span style="color: #ccaaff;">:r0</span> r0 <span style="color: #ccaaff;">:r1</span> r1 <span style="color: #ccaaff;">:pc</span> <span style="color: #aaccff;">(</span>+ pc <span style="color: #ccaaff;">2</span><span style="color: #aaccff;">)</span> <span style="color: #ccaaff;">:is</span> <span style="color: #ccaaff;">11</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgacfb721" class="outline-3">
<h3 id="orgacfb721">指令 12 : 將 R1 內容存入 位址 &lt;﻿data﻿&gt; 內</h3>
<div class="outline-text-3" id="text-orgacfb721">
<p>
指令 12 和指令 11 非常相似，只是將來源暫存器從 r0 改成 r1 而已。
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #aaffaa;">defn</span> <span style="color: #aaccff;">cmd12</span>
  <span style="color: #97abc6; font-style: italic;">"cmd 12: Store R1 into &lt;data&gt; position"</span>
  <span style="color: #81d4fa;">[</span><span style="color: #aaccff;">{</span><span style="color: #ccaaff;">:keys</span> <span style="color: #aaeecc;">[</span>memory r0 r1 pc is<span style="color: #aaeecc;">]</span><span style="color: #aaccff;">}</span><span style="color: #81d4fa;">]</span>
  <span style="color: #81d4fa;">(</span>make-cpu
   <span style="color: #ccaaff;">:memory</span> <span style="color: #aaccff;">(</span>assoc memory <span style="color: #aaeecc;">(</span>nth memory <span style="color: #ccaaff;">(</span>inc pc<span style="color: #ccaaff;">)</span><span style="color: #aaeecc;">)</span> r1<span style="color: #aaccff;">)</span>
   <span style="color: #ccaaff;">:r0</span> r0 <span style="color: #ccaaff;">:r1</span> r1 <span style="color: #ccaaff;">:pc</span> <span style="color: #aaccff;">(</span>+ pc <span style="color: #ccaaff;">2</span><span style="color: #aaccff;">)</span> <span style="color: #ccaaff;">:is</span> <span style="color: #ccaaff;">12</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgfa4b09b" class="outline-3">
<h3 id="orgfa4b09b">指令 13 : 將 PC 指向 位址 &lt;﻿data﻿&gt; (即 JUMP 命令)</h3>
<div class="outline-text-3" id="text-orgfa4b09b">
<p>
指令 13 其實就是一般 CPU 都會有的 <code>JUMP</code> 命令，透過更改 PC (Program Counter) 的
位址，來讓 CPU 去讀取不同記憶體位址。
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #aaffaa;">defn</span> <span style="color: #aaccff;">cmd13</span>
  <span style="color: #97abc6; font-style: italic;">"cmd 13: jump to address &lt;data&gt;"</span>
  <span style="color: #81d4fa;">[</span><span style="color: #aaccff;">{</span><span style="color: #ccaaff;">:keys</span> <span style="color: #aaeecc;">[</span>memory r0 r1 pc is<span style="color: #aaeecc;">]</span><span style="color: #aaccff;">}</span><span style="color: #81d4fa;">]</span>
  <span style="color: #81d4fa;">(</span>make-cpu
   <span style="color: #ccaaff;">:memory</span> memory <span style="color: #ccaaff;">:r0</span> r0 <span style="color: #ccaaff;">:r1</span> r1 <span style="color: #ccaaff;">:pc</span> <span style="color: #aaccff;">(</span>nth memory <span style="color: #aaeecc;">(</span>inc pc<span style="color: #aaeecc;">)</span><span style="color: #aaccff;">)</span> <span style="color: #ccaaff;">:is</span> <span style="color: #ccaaff;">13</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge87fbbf" class="outline-3">
<h3 id="orge87fbbf">指令 14 : 如果 R0 為 0，將 PC 指向 位址 &lt;﻿data﻿&gt;</h3>
<div class="outline-text-3" id="text-orge87fbbf">
<p>
指令 14 很單純，我們比對傳入的 r0 數值，若是 0 的話則將 PC (Program Counter) 調
整為 &lt;﻿data﻿&gt;，反之則進行 <code>pc + 2</code> 的動作，而判斷數值是否為 0，在 clojure 可以使用
<a href="https://clojuredocs.org/clojure.core/zero_q" target="_blank" rel="noopener">zero?</a> 進行判別
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span>zero? <span style="color: #ccaaff;">0</span><span style="color: #aadddd;">)</span> <span style="color: #9ac; font-style: italic;">; =&gt; true</span>
<span style="color: #aadddd;">(</span>zero? <span style="color: #ccaaff;">3</span><span style="color: #aadddd;">)</span> <span style="color: #9ac; font-style: italic;">; =&gt; false</span>
</pre>
</div>

<p>
因此我們指令 14 的實作就這樣完成了
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #aaffaa;">defn</span> <span style="color: #aaccff;">cmd14</span>
  <span style="color: #97abc6; font-style: italic;">"cmd 14: jump to address &lt;data&gt; if R0 == 0"</span>
  <span style="color: #81d4fa;">[</span><span style="color: #aaccff;">{</span><span style="color: #ccaaff;">:keys</span> <span style="color: #aaeecc;">[</span>memory r0 r1 pc is<span style="color: #aaeecc;">]</span><span style="color: #aaccff;">}</span><span style="color: #81d4fa;">]</span>
  <span style="color: #81d4fa;">(</span>make-cpu
   <span style="color: #ccaaff;">:memory</span> memory <span style="color: #ccaaff;">:r0</span> r0 <span style="color: #ccaaff;">:r1</span> r1
   <span style="color: #ccaaff;">:pc</span> <span style="color: #aaccff;">(</span><span style="color: #aaffaa;">if</span> <span style="color: #aaeecc;">(</span>zero? r0<span style="color: #aaeecc;">)</span>
         <span style="color: #aaeecc;">(</span>nth memory <span style="color: #ccaaff;">(</span>inc pc<span style="color: #ccaaff;">)</span><span style="color: #aaeecc;">)</span>
         <span style="color: #aaeecc;">(</span>+ pc <span style="color: #ccaaff;">2</span><span style="color: #aaeecc;">)</span><span style="color: #aaccff;">)</span>
   <span style="color: #ccaaff;">:is</span> <span style="color: #ccaaff;">14</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org8d18855" class="outline-3">
<h3 id="org8d18855">指令 15 : 如果 R0 不為 0, 將 PC 指向 位址 &lt;﻿data﻿&gt;</h3>
<div class="outline-text-3" id="text-org8d18855">
<p>
指令 15 其實和指令 14 一樣，我們只要調整 <code>if</code> 判斷式參數的順序就夠了，如果 R0 為
0，則進行 <code>pc + 2</code> ，反之則將 PC (Program Counter) 內容改為 &lt;﻿data﻿&gt; 數值。
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #aaffaa;">defn</span> <span style="color: #aaccff;">cmd15</span>
  <span style="color: #97abc6; font-style: italic;">"cmd 15: jump to address &lt;data&gt; if R0 != 0"</span>
  <span style="color: #81d4fa;">[</span><span style="color: #aaccff;">{</span><span style="color: #ccaaff;">:keys</span> <span style="color: #aaeecc;">[</span>memory r0 r1 pc is<span style="color: #aaeecc;">]</span><span style="color: #aaccff;">}</span><span style="color: #81d4fa;">]</span>
  <span style="color: #81d4fa;">(</span>make-cpu
   <span style="color: #ccaaff;">:memory</span> memory <span style="color: #ccaaff;">:r0</span> r0 <span style="color: #ccaaff;">:r1</span> r1
   <span style="color: #ccaaff;">:pc</span> <span style="color: #aaccff;">(</span><span style="color: #aaffaa;">if</span> <span style="color: #aaeecc;">(</span>zero? r0<span style="color: #aaeecc;">)</span>
         <span style="color: #aaeecc;">(</span>+ pc <span style="color: #ccaaff;">2</span><span style="color: #aaeecc;">)</span>
         <span style="color: #aaeecc;">(</span>nth memory <span style="color: #ccaaff;">(</span>inc pc<span style="color: #ccaaff;">)</span><span style="color: #aaeecc;">)</span><span style="color: #aaccff;">)</span>
   <span style="color: #ccaaff;">:is</span> <span style="color: #ccaaff;">15</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org9c4ac3a" class="outline-2">
<h2 id="org9c4ac3a">建立執行指令的迴圈</h2>
<div class="outline-text-2" id="text-org9c4ac3a">
<p>
當指令集完成後，是時候執行一個迴圈，不斷的執行記憶體內的命令直到結束，在這邊我們
的迴圈直接使用 <a href="https://clojuredocs.org/clojure.core/recur" target="_blank" rel="noopener">recur</a> 來完成，<a href="https://clojuredocs.org/clojure.core/recur" target="_blank" rel="noopener">recur</a> 是 Clojure 迴圈的一個方式，基本上就是讓函數自己
呼叫自己，直到結束，假如我們要實作倒數計時器，則可以這樣寫
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #aaffaa;">defn</span> <span style="color: #aaccff;">countdown</span> <span style="color: #81d4fa;">[</span>n<span style="color: #81d4fa;">]</span>
  <span style="color: #81d4fa;">(</span><span style="color: #aaffaa;">if</span> <span style="color: #aaccff;">(</span>zero? n<span style="color: #aaccff;">)</span>
    <span style="color: #aaccff;">(</span>println <span style="color: #aadddd;">"finished!"</span><span style="color: #aaccff;">)</span>
    <span style="color: #aaccff;">(</span><span style="color: #aaffaa;">do</span>
      <span style="color: #aaeecc;">(</span>println n<span style="color: #aaeecc;">)</span>
      <span style="color: #aaeecc;">(</span><span style="color: #aaffaa;">recur</span> <span style="color: #ccaaff;">(</span>dec n<span style="color: #ccaaff;">)</span><span style="color: #aaeecc;">)</span><span style="color: #aaccff;">)</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>

<span style="color: #aadddd;">(</span>countdown <span style="color: #ccaaff;">2</span><span style="color: #aadddd;">)</span>
<span style="color: #5f5f5f; font-style: italic;">;; </span><span style="color: #9ac; font-style: italic;">=&gt; 2</span>
<span style="color: #5f5f5f; font-style: italic;">;; </span><span style="color: #9ac; font-style: italic;">=&gt; 1</span>
<span style="color: #5f5f5f; font-style: italic;">;; </span><span style="color: #9ac; font-style: italic;">=&gt; finished!</span>
</pre>
</div>

<p>
上面的 countdown 命令，會自己呼叫自己直到輸入的參數為 0 為止，依照這個概念我們執
行指令集的迴圈，可以寫成下面這樣，實際根據指令進行執行的部分則由 <code>execute</code> 函式
完成。由於此 CPU 的指令 0 即代表 <code>終止程式</code> ，因此我們在此並未額外判斷要結
束 <a href="https://clojuredocs.org/clojure.core/recur" target="_blank" rel="noopener">recur</a> 回圈的條件。
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #aaffaa;">defn</span> <span style="color: #aaccff;">run</span> <span style="color: #81d4fa;">[</span>command<span style="color: #81d4fa;">]</span>
  <span style="color: #81d4fa;">(</span><span style="color: #aaffaa;">let</span> <span style="color: #aaccff;">[</span>cpu <span style="color: #aaeecc;">(</span>execute command<span style="color: #aaeecc;">)</span><span style="color: #aaccff;">]</span>
    <span style="color: #5f5f5f; font-style: italic;">;; </span><span style="color: #9ac; font-style: italic;">(print cpu) ;; for debug only</span>
    <span style="color: #aaccff;">(</span><span style="color: #aaffaa;">recur</span> cpu<span style="color: #aaccff;">)</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>

<p>
而在 <code>execute</code> 函式中，我們使用了 <a href="https://clojuredocs.org/clojure.core/try" target="_blank" rel="noopener">try &#x2026; catch</a> 來確保執行的狀態不會出錯，注意到
Node.js 在 <code>Exception</code> 的地方和 Clojure 不同，要使用 <code>js/Error</code> 來替代，假設進入
到了 catch 的區塊，則回傳 0 給 curr 變數，讓他進入到 <code>default</code> 的命令，在這邊就
是 <code>cmd0</code> ，也就是說一旦程式出錯，就強行終止程式。
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #aaffaa;">defn</span> <span style="color: #aaccff;">execute</span> <span style="color: #81d4fa;">[</span>state<span style="color: #81d4fa;">]</span>
  <span style="color: #81d4fa;">(</span><span style="color: #aaffaa;">let</span> <span style="color: #aaccff;">[</span>curr
        <span style="color: #aaeecc;">(</span><span style="color: #aaffaa;">try</span> <span style="color: #ccaaff;">(</span>nth <span style="color: #fff59d;">(</span><span style="color: #ccaaff;">:memory</span> state<span style="color: #fff59d;">)</span> <span style="color: #fff59d;">(</span><span style="color: #ccaaff;">:pc</span> state<span style="color: #fff59d;">)</span><span style="color: #ccaaff;">)</span>
             <span style="color: #ccaaff;">(</span><span style="color: #aaffaa;">catch</span>
                 #?<span style="color: #fff59d;">(</span><span style="color: #ccaaff;">:clj</span>
                    Exception
                    <span style="color: #ccaaff;">:cljs</span>
                    <span style="color: #fff59d;">js</span>/Error<span style="color: #fff59d;">)</span> _ <span style="color: #ccaaff;">0</span><span style="color: #ccaaff;">)</span><span style="color: #aaeecc;">)</span><span style="color: #aaccff;">]</span>
    <span style="color: #5f5f5f; font-style: italic;">;; </span><span style="color: #9ac; font-style: italic;">(println state)</span>
    <span style="color: #aaccff;">(</span><span style="color: #aaffaa;">case</span> curr
      <span style="color: #5f5f5f; font-style: italic;">;; </span><span style="color: #9ac; font-style: italic;">1-byte instruction</span>
      <span style="color: #ccaaff;">1</span> <span style="color: #aaeecc;">(</span>cmd1 state<span style="color: #aaeecc;">)</span>
      <span style="color: #ccaaff;">2</span> <span style="color: #aaeecc;">(</span>cmd2 state<span style="color: #aaeecc;">)</span>
      <span style="color: #ccaaff;">3</span> <span style="color: #aaeecc;">(</span>cmd3 state<span style="color: #aaeecc;">)</span>
      <span style="color: #ccaaff;">4</span> <span style="color: #aaeecc;">(</span>cmd4 state<span style="color: #aaeecc;">)</span>
      <span style="color: #ccaaff;">5</span> <span style="color: #aaeecc;">(</span>cmd5 state<span style="color: #aaeecc;">)</span>
      <span style="color: #ccaaff;">6</span> <span style="color: #aaeecc;">(</span>cmd6 state<span style="color: #aaeecc;">)</span>
      <span style="color: #ccaaff;">7</span> <span style="color: #aaeecc;">(</span>cmd7 state<span style="color: #aaeecc;">)</span>
      <span style="color: #5f5f5f; font-style: italic;">;; </span><span style="color: #9ac; font-style: italic;">2-byte instruction</span>
      <span style="color: #ccaaff;">8</span> <span style="color: #aaeecc;">(</span>cmd8 state<span style="color: #aaeecc;">)</span>
      <span style="color: #ccaaff;">9</span> <span style="color: #aaeecc;">(</span>cmd9 state<span style="color: #aaeecc;">)</span>
      <span style="color: #ccaaff;">10</span> <span style="color: #aaeecc;">(</span>cmd10 state<span style="color: #aaeecc;">)</span>
      <span style="color: #ccaaff;">11</span> <span style="color: #aaeecc;">(</span>cmd11 state<span style="color: #aaeecc;">)</span>
      <span style="color: #ccaaff;">12</span> <span style="color: #aaeecc;">(</span>cmd12 state<span style="color: #aaeecc;">)</span>
      <span style="color: #ccaaff;">13</span> <span style="color: #aaeecc;">(</span>cmd13 state<span style="color: #aaeecc;">)</span>
      <span style="color: #ccaaff;">14</span> <span style="color: #aaeecc;">(</span>cmd14 state<span style="color: #aaeecc;">)</span>
      <span style="color: #ccaaff;">15</span> <span style="color: #aaeecc;">(</span>cmd15 state<span style="color: #aaeecc;">)</span>
      <span style="color: #5f5f5f; font-style: italic;">;; </span><span style="color: #9ac; font-style: italic;">default</span>
      <span style="color: #aaeecc;">(</span>cmd0 state<span style="color: #aaeecc;">)</span><span style="color: #aaccff;">)</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org89f287c" class="outline-2">
<h2 id="org89f287c">進行最後的修改</h2>
<div class="outline-text-2" id="text-org89f287c">
<p>
我們可以丟幾道簡單的程式讓 4917 模擬器執行看看
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span>run <span style="color: #81d4fa;">(</span>make-cpu <span style="color: #ccaaff;">:memory</span> <span style="color: #aaccff;">[</span> <span style="color: #ccaaff;">7</span> <span style="color: #ccaaff;">0</span> <span style="color: #aaccff;">]</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
<span style="color: #5f5f5f; font-style: italic;">;; </span><span style="color: #9ac; font-style: italic;">=&gt; Ring the bell!!</span>
</pre>
</div>

<p>
或是讓他印出 5 這個數字
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span>run <span style="color: #81d4fa;">(</span>make-cpu <span style="color: #ccaaff;">:memory</span> <span style="color: #aaccff;">[</span> <span style="color: #ccaaff;">8</span> <span style="color: #ccaaff;">5</span> <span style="color: #aaccff;">]</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
<span style="color: #5f5f5f; font-style: italic;">;; </span><span style="color: #9ac; font-style: italic;">=&gt; 5</span>
</pre>
</div>

<p>
確認模擬器執行成功後，是時候修正我們得 <code>main</code> 方法了，調整成如下就完成整個程式囉 ~
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #aadddd;">(</span><span style="color: #aaffaa;">defn</span> <span style="color: #aaccff;">-main</span> <span style="color: #81d4fa;">[</span>&amp; args<span style="color: #81d4fa;">]</span>
  <span style="color: #81d4fa;">(</span><span style="color: #aaffaa;">let</span> <span style="color: #aaccff;">[</span>arg1 <span style="color: #aaeecc;">(</span>nth args <span style="color: #ccaaff;">0</span><span style="color: #aaeecc;">)</span><span style="color: #aaccff;">]</span>
    <span style="color: #aaccff;">(</span><span style="color: #aaffaa;">if</span> arg1
      <span style="color: #aaeecc;">(</span>run <span style="color: #ccaaff;">(</span>make-cpu <span style="color: #ccaaff;">:memory</span> <span style="color: #fff59d;">(</span>parse-rom arg1<span style="color: #fff59d;">)</span><span style="color: #ccaaff;">)</span><span style="color: #aaeecc;">)</span>
      <span style="color: #aaeecc;">(</span>println <span style="color: #aadddd;">"Error: Please specify filename."</span><span style="color: #aaeecc;">)</span><span style="color: #aaccff;">)</span><span style="color: #81d4fa;">)</span><span style="color: #aadddd;">)</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org6fe4e55" class="outline-2">
<h2 id="org6fe4e55">取得完整程式碼與執行程式</h2>
<div class="outline-text-2" id="text-org6fe4e55">
<p>
本篇文章的完整程式碼已經放置於 <a href="https://github.com/coldnew/emulator-4917" target="_blank" rel="noopener">GitHub</a> 上，你可以使用以下方式取得程式碼
</p>

<pre class="example">
git clone https://github.com/coldnew/emulator-4917.git
</pre>


<p>
而在 examples 資料夾共放了以下幾種 4917 的範例二進制程式
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col class="org-left">

<col class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">檔案名稱</th>
<th scope="col" class="org-left">功能說明</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left">countdown.bin</td>
<td class="org-left">從 5 開始倒數計數到 1</td>
</tr>

<tr>
<td class="org-left">countup.bin</td>
<td class="org-left">從 0 開始不斷往上數</td>
</tr>

<tr>
<td class="org-left">bell.bin</td>
<td class="org-left">響三次鈴聲</td>
</tr>

<tr>
<td class="org-left">calculate_6+3+1.bin</td>
<td class="org-left">計算 6 + 3 + 1</td>
</tr>
</tbody>
</table>
</div>

<div id="outline-container-org932df44" class="outline-3">
<h3 id="org932df44">執行程式 (JVM)</h3>
<div class="outline-text-3" id="text-org932df44">
<p>
若要使用 JVM 來執行本篇文章的程式，則可以直接使用 <code>lein run</code> 進行
</p>

<div class="org-src-container">
<pre class="src src-sh">lein run -- examples/countdown.bin
</pre>
</div>

<p>
或是你也可以透過 <code>lein uberjar</code> 功能將其打包成 .jar 檔案再執行
</p>

<div class="org-src-container">
<pre class="src src-sh">lein uberjar
java -jar target/emulator-4917-0.1.0-SNAPSHOT-standalone.jar examples/countdown.bin
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc32f572" class="outline-3">
<h3 id="orgc32f572">執行程式 (Node.js)</h3>
<div class="outline-text-3" id="text-orgc32f572">
<p>
本篇文章預設是使用 <code>none</code> 最佳化編譯, 因此需透過 <code>run.js</code> 來協助執行程式
</p>

<div class="org-src-container">
<pre class="src src-sh">node run.js  examples/countdown.bin
</pre>
</div>

<p>
你也可以修改 <code>project.clj</code> 將其變成如下
</p>

<div class="org-src-container">
<pre class="src src-clojure"><span style="color: #ccaaff;">:optimizations</span> <span style="color: #ccaaff;">:advanced</span>
<span style="color: #ccaaff;">:pretty-print</span> <span style="color: #ccaaff;">false</span>
</pre>
</div>

<p>
接著重新編譯就可以獲得最佳化(並且沒人看得懂的) javascript 了，執行方式如下:
</p>

<div class="org-src-container">
<pre class="src src-sh">lein cljsbuild once
node target/emulator-4917.js examples/countdown.bin
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org581d141" class="outline-2">
<h2 id="org581d141">延伸閱讀</h2>
<div class="outline-text-2" id="text-org581d141">
<p>
<code>[1]</code> <a href="https://www.youtube.com/watch?v%3DgTeDX4yAdyU&amp;index%3D3&amp;list%3DPL6B940F08B9773B9F&amp;hd%3D1" target="_blank" rel="noopener">Youtube - Lecture 3: Machine Code - Richard Buckland UNSW</a>
</p>

<p>
<code>[2]</code> <a href="http://paarsgames.nl/2013/07/29/e-4917-emulator-in-clojure/" target="_blank" rel="noopener">e-4917 emulator in Clojure</a>
</p>

<p>
<code>[3]</code> <a href="https://andrewharvey4.wordpress.com/2009/03/13/comp2121-wk01/" target="_blank" rel="noopener">Andrew Harvey's Blog - COMP2121 – Wk01</a>
</p>

<p>
<code>[4]</code> <a href="https://wiki.cse.unsw.edu.au/info/COMP1917" target="_blank" rel="noopener">https://wiki.cse.unsw.edu.au/info/COMP1917</a>
</p>

<p>
<code>[5]</code> <a href="http://dev.clojure.org/display/design/Reader%2BConditionals" target="_blank" rel="noopener">Clojure docs - Reader Conditionals</a>
</p>
</div>
</div>
</div>
</span>
      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/clojure/" rel="tag">#clojure</a>
          
            <a href="/tags/clojurescript/" rel="tag">#clojurescript</a>
          
            <a href="/tags/emulator/" rel="tag">#emulator</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-prev post-nav-item">
            
              <a href="/64f655a5/" rel="prev">COSCUP 2015 "Build yor own Embedded Linux distributions by Yocto project" 投影片</a>
            
          </div>

          <div class="post-nav-next post-nav-item">
            
              <a href="/6586e49f/" rel="next">Why I think Geeksphone Revolution is not a developer friendly phone</a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>

 </div>

        
          <div class="comments" id="comments">
            
               <div id="gitalk-container"></div>
            
          </div>
        
      </div>

      
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目錄
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            本站概覽
          </li>
        </ul>
      

      <section class="site-overview">
        <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="https://schema.org/Person">
          <img class="site-author-image" src="https://www.gravatar.com/avatar/bda0c97c8dca6eb45824d1b83f477ad9" alt="Yen-Chin, Lee" itemprop="image">
          <p class="site-author-name" itemprop="name">Yen-Chin, Lee</p>
        </div>
        <p class="site-description motion-element" itemprop="description"></p>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">133</span>
              <span class="site-state-item-name">文章</span>
            </a>
          </div>

          <div class="site-state-item site-state-categories">
            <a href="/categories">
              <span class="site-state-item-count">16</span>
              <span class="site-state-item-name">分類</span>
              </a>
          </div>

          <div class="site-state-item site-state-tags">
            <a href="/tags">
              <span class="site-state-item-count">103</span>
              <span class="site-state-item-name">標籤</span>
              </a>
          </div>

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/rss.xml" rel="alternate">
              <i class="menu-item-icon icon-next-feed"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/coldnew" target="_blank">github</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://plus.google.com/u/0/106837301382084981260/posts" target="_blank">google+</a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://www.linkedin.com/in/coldnew/" target="_blank">linkedln</a>
              </span>
            
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="https://creativecommons.org/licenses/by-nc-sa/4.0" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons">
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
        </div>

      </section>

      
        <section class="post-toc-wrap sidebar-panel-active">
          <div class="post-toc-indicator-top post-toc-indicator"></div>
          <div class="post-toc">
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#orgbe225a2"><span class="nav-text">4917 的暫存器 (Register)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#org84850a9"><span class="nav-text">從指令集認識 4917</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#orgc4b780e"><span class="nav-text">1-byte 指令</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#org2685b39"><span class="nav-text">2-byte 指令，指令後面的 byte 的內容以 &lt;﻿data﻿&gt; 表示</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#org9c5dd10"><span class="nav-text">從範例來看 4917 的指令運作</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#org7c6e5cd"><span class="nav-text">建立我們的 Clojure/Clojurescript 專案</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#org8a18b7d"><span class="nav-text">建立初始樣板</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#org9f02a97"><span class="nav-text">讀取二進制檔案並解析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#org3575366"><span class="nav-text">建立 4917 這顆 CPU</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#org286d59d"><span class="nav-text">定義指令集</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#org29cf8fe"><span class="nav-text">指令 0 : 結束程式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#org344db94"><span class="nav-text">指令 1 : R0 = R0 + R1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#orgb2e68a6"><span class="nav-text">指令 2 : R0 = R0 - R1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#orgae7d6a7"><span class="nav-text">指令 3 : R0 = R0 + 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#orgf8e4b1b"><span class="nav-text">指令 4 : R1 = R1 + 1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#org1f15302"><span class="nav-text">指令 5 : R0 = R0 -1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#orge1623c4"><span class="nav-text">指令 6 : R1 = R1 -1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#orga49c7c7"><span class="nav-text">指令 7 : 響鈴</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#orgcc23f08"><span class="nav-text">指令 8 : 印出 &lt;﻿data﻿&gt;</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#org4ea0628"><span class="nav-text">指令 9 : 從位址 &lt;﻿data﻿&gt; 讀取資料存入 R0</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#orgd8fd1a8"><span class="nav-text">指令 10 : 從位址 &lt;﻿data﻿&gt; 讀取資料存入 R1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#org653c9b2"><span class="nav-text">指令 11 : 將 R0 內容存入 位址 &lt;﻿data﻿&gt; 內</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#orgacfb721"><span class="nav-text">指令 12 : 將 R1 內容存入 位址 &lt;﻿data﻿&gt; 內</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#orgfa4b09b"><span class="nav-text">指令 13 : 將 PC 指向 位址 &lt;﻿data﻿&gt; (即 JUMP 命令)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#orge87fbbf"><span class="nav-text">指令 14 : 如果 R0 為 0，將 PC 指向 位址 &lt;﻿data﻿&gt;</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#org8d18855"><span class="nav-text">指令 15 : 如果 R0 不為 0, 將 PC 指向 位址 &lt;﻿data﻿&gt;</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#org9c4ac3a"><span class="nav-text">建立執行指令的迴圈</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#org89f287c"><span class="nav-text">進行最後的修改</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#org6fe4e55"><span class="nav-text">取得完整程式碼與執行程式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#org932df44"><span class="nav-text">執行程式 (JVM)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#orgc32f572"><span class="nav-text">執行程式 (Node.js)</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#org581d141"><span class="nav-text">延伸閱讀</span></a></li></ol></div>
            
          </div>
          <div class="post-toc-indicator-bottom post-toc-indicator"></div>
        </section>
      

    </div>
  </aside>


    </main>

    <footer id="footer" class="container">
      <div class="footer">
        <div class="footer-inner"> 
<div class="copyright">
  
  Copyright  &copy; &nbsp;  2012 - 
  <span itemprop="copyrightYear">2020</span>
  <span class="author" itemprop="copyrightHolder">Yen-Chin, Lee</span>
   &middot;  Powered by  <a href="https://github.com/coldnew/hexo-renderer-org" target="_blank">coldnew/hexo-renderer-org</a>
</div>

<!--
<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 強力驅動
</div>

<div class="theme-info">
  主題 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>
-->


 </div>
      </div>
    </footer>

    <div class="back-to-top"></div>
  </div>

  <!-- <script type="text/javascript" src="/vendors/jquery/dist/jquery.min.js"></script> -->
  <!-- <link rel="stylesheet" href="/vendors/bootstrap/dist/css/bootstrap.min.css" type="text/css"> -->
  <!-- <script type="text/javascript" src="/vendors/bootstrap/dist/js/bootstrap.min.js"></script> -->

  
  
  
    
  
  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js"></script>
  <script type="text/javascript" src="/js/fancy-box.js?v=0.4.5.1"></script>


  <script type="text/javascript" src="/js/helpers.js?v=0.4.5.1"></script>
  

  <script type="text/javascript" src="/vendors/velocity/velocity.min.js"></script>
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js"></script>

  <script type="text/javascript" src="/js/motion_global.js?v=0.4.5.1" id="motion.global"></script>




  <script type="text/javascript" src="/js/nav-toggle.js?v=0.4.5.1"></script>
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  
<script type="text/javascript" src="/js/bootstrap.scrollspy.js?v=0.4.5.1" id="bootstrap.scrollspy.custom"></script>


<script type="text/javascript" id="sidebar.toc.highlight">
  $(document).ready(function () {
    var tocSelector = '.post-toc';
    var $tocSelector = $(tocSelector);
    var activeCurrentSelector = '.active-current';

    $tocSelector
      .on('activate.bs.scrollspy', function () {
        var $currentActiveElement = $(tocSelector + ' .active').last();

        removeCurrentActiveClass();
        $currentActiveElement.addClass('active-current');

        $tocSelector[0].scrollTop = $currentActiveElement.position().top;
      })
      .on('clear.bs.scrollspy', function () {
        removeCurrentActiveClass();
      });

    function removeCurrentActiveClass () {
      $(tocSelector + ' ' + activeCurrentSelector)
        .removeClass(activeCurrentSelector.substring(1));
    }

    function processTOC () {
      getTOCMaxHeight();
      toggleTOCOverflowIndicators();
    }

    function getTOCMaxHeight () {
      var height = $('.sidebar').height() -
                   $tocSelector.position().top -
                   $('.post-toc-indicator-bottom').height();

      $tocSelector.css('height', height);

      return height;
    }

    function toggleTOCOverflowIndicators () {
      tocOverflowIndicator(
        '.post-toc-indicator-top',
        $tocSelector.scrollTop() > 0 ? 'show' : 'hide'
      );

      tocOverflowIndicator(
        '.post-toc-indicator-bottom',
        $tocSelector.scrollTop() >= $tocSelector.find('ol').height() - $tocSelector.height() ? 'hide' : 'show'
      )
    }

    $(document).on('sidebar.motion.complete', function () {
      processTOC();
    });

    $('body').scrollspy({ target: tocSelector });
    $(window).on('resize', function () {
      if ( $('.sidebar').hasClass('sidebar-active') ) {
        processTOC();
      }
    });

    onScroll($tocSelector);

    function onScroll (element) {
      element.on('mousewheel DOMMouseScroll', function (event) {
          var oe = event.originalEvent;
          var delta = oe.wheelDelta || -oe.detail;

          this.scrollTop += ( delta < 0 ? 1 : -1 ) * 30;
          event.preventDefault();

          toggleTOCOverflowIndicators();
      });
    }

    function tocOverflowIndicator (indicator, action) {
      var $indicator = $(indicator);
      var opacity = action === 'show' ? 0.4 : 0;
      $indicator.velocity ?
        $indicator.velocity('stop').velocity({
          opacity: opacity
        }, { duration: 100 }) :
        $indicator.stop().animate({
          opacity: opacity
        }, 100);
    }

  });
</script>

<script type="text/javascript" id="sidebar.nav">
  $(document).ready(function () {
    var html = $('html');
    var TAB_ANIMATE_DURATION = 200;
    var hasVelocity = $.isFunction(html.velocity);

    $('.sidebar-nav li').on('click', function () {
      var item = $(this);
      var activeTabClassName = 'sidebar-nav-active';
      var activePanelClassName = 'sidebar-panel-active';
      if (item.hasClass(activeTabClassName)) {
        return;
      }

      var currentTarget = $('.' + activePanelClassName);
      var target = $('.' + item.data('target'));

      hasVelocity ?
        currentTarget.velocity('transition.slideUpOut', TAB_ANIMATE_DURATION, function () {
          target
            .velocity('stop')
            .velocity('transition.slideDownIn', TAB_ANIMATE_DURATION)
            .addClass(activePanelClassName);
        }) :
        currentTarget.animate({ opacity: 0 }, TAB_ANIMATE_DURATION, function () {
          currentTarget.hide();
          target
            .stop()
            .css({'opacity': 0, 'display': 'block'})
            .animate({ opacity: 1 }, TAB_ANIMATE_DURATION, function () {
              currentTarget.removeClass(activePanelClassName);
              target.addClass(activePanelClassName);
            });
        });

      item.siblings().removeClass(activeTabClassName);
      item.addClass(activeTabClassName);
    });

    $('.post-toc a').on('click', function (e) {
      e.preventDefault();
      var targetSelector = escapeSelector(this.getAttribute('href'));
      var offset = $(targetSelector).offset().top;
      hasVelocity ?
        html.velocity('stop').velocity('scroll', {
          offset: offset  + 'px',
          mobileHA: false
        }) :
        $('html, body').stop().animate({
          scrollTop: offset
        }, 500);
    });

    // Expand sidebar on post detail page by default, when post has a toc.
    var $tocContent = $('.post-toc-content');
    if (isDesktop() && CONFIG.sidebar === 'post') {
      if ($tocContent.length > 0 && $tocContent.html().trim().length > 0) {
        displaySidebar();
      }
    }
  });
</script>



  <script type="text/javascript">
    $(document).ready(function () {
      if (CONFIG.sidebar === 'always') {
        displaySidebar();
      }
      if (isMobile()) {
        FastClick.attach(document.body);
      }
    });
  </script>

  

  
  


  
  <script type="text/javascript" src="/js/lazyload.js"></script>
  <script type="text/javascript">
    $(function () {
      $("#posts").find('img').lazyload({
        placeholder: "/images/loading.gif",
        effect: "fadeIn"
      });
    });
  </script>
  <script type="text/javascript" src="/js/app.js"></script>

<!-- LOCAL: You can save these files to your site and update links -->
  
  <link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css">
  <script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script>
<!-- END LOCAL -->
    
      <script type="text/javascript">
      function renderGitalk(){
        var gitalk = new Gitalk({
            owner: 'coldnew',
            repo: 'coldnew.github.io',
            clientID: 'b68fc8fd50fcc051b95e',
            clientSecret: '7f005263788db4a303b57e8296bb6800de1f9acf',
            admin: 'coldnew',
            
              distractionFreeMode: 'true'
            
            });
        gitalk.render('gitalk-container');
      }
      renderGitalk();
      </script>
    

</body>
</html>
